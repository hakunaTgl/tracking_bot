<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Bot Hub</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/idb@7.0.1/build/iife/index-min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1E40AF">
  <meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const BotHub = () => {
      const [bots, setBots] = useState([]);
      const [command, setCommand] = useState("");
      const [globalCommand, setGlobalCommand] = useState("");
      const [codePrompt, setCodePrompt] = useState("");
      const [editingBot, setEditingBot] = useState(null);
      const [code, setCode] = useState("");
      const [logs, setLogs] = useState([]);
      const [aiChat, setAiChat] = useState([{ user: "", ai: "I’m the Unified AI, your hub’s brain. Build bots, check status, or chat!" }]);
      const [file, setFile] = useState(null);
      const [codeAnalysis, setCodeAnalysis] = useState(null);
      const [suggestions, setSuggestions] = useState(["Crypto Tracker Bot"]);
      const [addFunctionOption, setAddFunctionOption] = useState("");

      // Initialize IndexedDB and Unified AI
      useEffect(() => {
        const initDB = async () => {
          const db = await idb.openDB('bot-hub', 1, {
            upgrade(db) {
              db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
              db.createObjectStore('bots', { keyPath: 'id' });
              db.createObjectStore('inputs', { keyPath: 'id', autoIncrement: true });
            }
          });
          const savedLogs = await db.getAll('logs');
          const savedBots = await db.getAll('bots');
          setLogs(savedLogs.map(log => log.message));
          setBots(savedBots);
          // Unified AI proactive check
          if (savedBots.length > 0) {
            const idleBots = savedBots.filter(b => b.status === "Idle").map(b => b.name).join(", ");
            if (idleBots) {
              setAiChat(c => [...c, { user: "", ai: `Idle bots: ${idleBots}. Deploy them?` }]);
            }
          }
        };
        initDB();
      }, []);

      // Save to IndexedDB
      const saveLog = async (message) => {
        const db = await idb.openDB('bot-hub', 1);
        await db.add('logs', { message, timestamp: new Date().toISOString() });
        setLogs([...logs, message]);
      };

      const saveBot = async (bot) => {
        const db = await idb.openDB('bot-hub', 1);
        await db.put('bots', bot);
        setBots([...bots.filter(b => b.id !== bot.id), bot]);
      };

      const saveInput = async (input) => {
        const db = await idb.openDB('bot-hub', 1);
        await db.add('inputs', { input, timestamp: new Date().toISOString() });
        // Unified AI suggests hub enhancements
        if (input.includes("weather") && !suggestions.includes("Weather Dashboard")) {
          setSuggestions([...suggestions, "Weather Dashboard"]);
          setAiChat(c => [...c, { user: "", ai: "Frequent weather bots detected. Add a weather dashboard?" }]);
        }
      };

      const clearLogs = async () => {
        const db = await idb.openDB('bot-hub', 1);
        await db.clear('logs');
        setLogs([]);
        saveLog("Logs cleared");
      };

      // Unified AI Logic
      const askAiQuestion = (prompt) => {
        let response;
        const lowerPrompt = prompt.toLowerCase();
        // Hub queries
        if (lowerPrompt.includes("hub") || lowerPrompt.includes("status") || lowerPrompt.includes("bots")) {
          const runningBots = bots.filter(b => b.status === "Running").map(b => b.name).join(", ");
          response = lowerPrompt.includes("running")
            ? `Running bots: ${runningBots || "None"}`
            : `Hub status: ${bots.length} bots, ${logs.length} logs. Want details?`;
        }
        // Bot-building
        else if (lowerPrompt.includes("build") || lowerPrompt.includes("create") || lowerPrompt.includes("bot")) {
          if (lowerPrompt.includes("web scraper")) {
            response = "Target website? Save as JSON, CSV, or database?";
          } else if (lowerPrompt.includes("weather")) {
            response = "City or ZIP code? Daily or hourly updates? Email alerts?";
          } else if (lowerPrompt.includes("stock")) {
            response = "Which stocks or exchanges? Real-time or daily? Notifications?";
          } else {
            response = "What’s the bot’s main goal? Data source or output format?";
          }
        }
        // General conversation
        else {
          response = `Cool, you said: "${prompt}". Wanna talk bots, hub, or just vibe?`;
        }
        setAiChat([...aiChat, { user: prompt, ai: response }]);
        saveLog(`Unified AI: ${response}`);
        if (lowerPrompt.includes("bot")) saveInput(prompt);
      };

      const handleFileUpload = (e) => {
        const uploadedFile = e.target.files[0];
        setFile(uploadedFile);
        saveLog(`File uploaded: ${uploadedFile.name}`);
        askAiQuestion(`Uploaded file: ${uploadedFile.name}`);
      };

      const sendCommand = (botId, cmd) => {
        saveLog(`Command "${cmd}" sent to Bot ${botId}`);
        const newStatus = cmd === "Start" ? "Running" : cmd === "Stop" ? "Idle" : "Restarting";
        const updatedBot = { ...bots.find(bot => bot.id === botId), status: newStatus };
        saveBot(updatedBot);
      };

      const sendGlobalCommand = () => {
        if (!globalCommand) return;
        saveLog(`Global command "${globalCommand}" sent to all bots`);
        const newStatus = globalCommand === "Start All" ? "Running" : globalCommand === "Stop All" ? "Idle" : "Restarting";
        const updatedBots = bots.map(bot => ({ ...bot, status: newStatus }));
        updatedBots.forEach(saveBot);
        setGlobalCommand("");
      };

      const generateCode = () => {
        if (!codePrompt && !file) return;
        const input = codePrompt || (file ? file.name : "");
        askAiQuestion(input);
        let generatedCode, description;
        if (input.toLowerCase().includes("weather")) {
          generatedCode = `import requests
# Fetches weather data for a city and sends email alerts
def fetch_weather(city):
    try:
        url = f"https://api.weatherapi.com/v1/current.json?key=YOUR_KEY&q={city}"
        response = requests.get(url)
        if response.status_code == 200:
            return response.json()
        else:
            raise Exception("API request failed")
    except Exception as e:
        print(f"Error: {e}")
        return None

def send_email(data, recipient):
    # Placeholder: Implement SMTP email sending
    print(f"Sending weather data to {recipient}: {data}")
`;
          description = "Fetches current weather for a specified city using Weather API, handles errors, and sends data via email.";
        } else if (input.toLowerCase().includes("scraper")) {
          generatedCode = `import requests
from bs4 import BeautifulSoup
# Scrapes a website and extracts data
def scrape_website(url):
    try:
        response = requests.get(url)
        if response.status_code == 200:
            soup = BeautifulSoup(response.text, 'html.parser')
            # Example: Extract all paragraph texts
            data = [p.text for p in soup.find_all('p')]
            return data
        else:
            raise Exception("Failed to fetch website")
    except Exception as e:
        print(f"Error: {e}")
        return None

def save_data(data, format='json'):
    # Placeholder: Save data to file
    print(f"Saving data in {format}: {data}")
`;
          description = "Scrapes a website for paragraph text using BeautifulSoup, handles errors, and saves data in JSON or CSV.";
        } else {
          generatedCode = `def run():
    # Custom bot logic for: ${input}
    print("Executing bot for: ${input}")
`;
          description = "Basic bot template for custom tasks.";
        }
        const analysis = {
          name: input.split(" ")[0] + " Bot",
          functions: generatedCode.match(/def [a-zA-Z_]+\(/g)?.map(f => f.replace("def ", "").replace("(", "()")) || ["run()"],
          value: `Automates ${input}, saves ~2-4 hours/week`,
          risk: "API downtime, rate limits, or parsing errors may occur",
          description
        };
        setCode(generatedCode);
        setCodeAnalysis(analysis);
        saveLog(`Code generated for: "${input}"`);
        setCodePrompt("");
        setFile(null);
      };

      const suggestEdits = () => {
        const suggestion = code.includes("requests") 
          ? "Add retry logic with exponential backoff?"
          : "Add input validation to main function?";
        setAiChat([...aiChat, { user: "Suggest edits", ai: suggestion }]);
        saveLog(`Unified AI suggested: ${suggestion}`);
      };

      const addFunction = () => {
        if (!addFunctionOption) return;
        let newCode = code;
        if (addFunctionOption === "Logging") {
          newCode += `
def log_activity(message):
    with open('bot.log', 'a') as f:
        f.write(f"{message}\\n")
    print(f"Logged: {message}")
`;
        } else if (addFunctionOption === "Email") {
          newCode += `
def send_email(subject, body, recipient):
    # Placeholder: Implement SMTP email sending
    print(f"Sending email to {recipient}: {subject}")
`;
        }
        setCode(newCode);
        setCodeAnalysis({
          ...codeAnalysis,
          functions: [...codeAnalysis.functions, addFunctionOption === "Logging" ? "log_activity()" : "send_email()"]
        });
        saveLog(`Added function: ${addFunctionOption}`);
        setAddFunctionOption("");
      };

      const removeFunction = (func) => {
        const lines = code.split("\n");
        const funcStart = lines.findIndex(line => line.includes(`def ${func.replace("()", "")}(`));
        if (funcStart === -1) return;
        const funcEnd = lines.slice(funcStart).findIndex(line => !line.startsWith(" ")) + funcStart;
        const newCode = [...lines.slice(0, funcStart), ...lines.slice(funcEnd + 1)].join("\n");
        setCode(newCode);
        setCodeAnalysis({
          ...codeAnalysis,
          functions: codeAnalysis.functions.filter(f => f !== func)
        });
        saveLog(`Removed function: ${func}`);
      };

      const refineDetails = () => {
        const suggestion = code.includes("weather") 
          ? "Change to hourly updates or add multiple cities?"
          : "Specify data format or update frequency?";
        setAiChat([...aiChat, { user: "Refine details", ai: suggestion }]);
        saveLog(`Unified AI suggested: ${suggestion}`);
      };

      const copyCode = () => {
        navigator.clipboard.writeText(code);
        saveLog("Code copied to clipboard");
      };

      const createBot = () => {
        const newBot = {
          id: bots.length + 1,
          name: codeAnalysis.name,
          code,
          analysis: codeAnalysis,
          status: "Deployed",
          performance: 80
        };
        saveBot(newBot);
        saveLog(`Bot created: ${newBot.name}`);
        setCode("");
        setCodeAnalysis(null);
        setSuggestions([...suggestions, `${newBot.name} Enhanced`]);
      };

      const startEditing = (bot) => {
        setEditingBot(bot);
        setCode(bot.code);
      };

      const saveCode = () => {
        saveLog(`Code saved for ${editingBot.name}`);
        const updatedBot = { ...editingBot, code, status: "Updated" };
        saveBot(updatedBot);
        setEditingBot(null);
        setCode("");
      };

      const debugBot = (botId) => {
        const bot = bots.find(b => b.id === botId);
        const debugResult = bot.code.includes("requests") 
          ? "Checked: requests imported, ensure API key"
          : "Checked: No syntax errors, verify logic";
        saveLog(`Debugging Bot ${botId}: ${debugResult}`);
      };

      const deployBot = (botId) => {
        saveLog(`Bot ${botId} deployed`);
        const updatedBot = { ...bots.find(bot => bot.id === botId), status: "Deployed" };
        saveBot(updatedBot);
      };

      const createSuggestedBot = (suggestion) => {
        setCodePrompt(suggestion);
        generateCode();
      };

      return (
        <div className="p-4 max-w-full mx-auto bg-gray-100 min-h-screen flex flex-col text-base">
          <h1 className="text-2xl font-bold mb-4 text-blue-800 text-center">Smart Bot Hub</h1>

          {/* Unified AI */}
          <div className="mb-4 bg-white p-4 rounded shadow">
            <h2 className="text-lg font-semibold mb-2">Unified AI</h2>
            <div className="h-48 overflow-y-auto border p-2 text-base mb-2">
              {aiChat.map((chat, index) => (
                <div key={index} className="mb-2">
                  {chat.user && <p><strong>You:</strong> {chat.user}</p>}
                  <p><strong>AI:</strong> {chat.ai}</p>
                </div>
              ))}
            </div>
            <input 
              type="text" 
              value={codePrompt} 
              onChange={(e) => setCodePrompt(e.target.value)} 
              placeholder="Build a bot, check status, or chat"
              className="border p-3 w-full mb-2 text-base rounded"
              onKeyPress={(e) => e.key === 'Enter' && askAiQuestion(codePrompt)}
            />
            <button 
              onClick={() => setAiChat([{ user: "", ai: "Unified AI reset. Build, check, or chat?" }])}
              className="w-full bg-red-500 text-white py-3 rounded"
            >
              Reset Chat
            </button>
          </div>

          {/* File Upload */}
          <div className="mb-4 bg-white p-4 rounded shadow">
            <h2 className="text-lg font-semibold mb-2">Upload Idea</h2>
            <input 
              type="file" 
              accept=".txt,.pdf" 
              onChange={handleFileUpload}
              className="w-full mb-2 text-base"
            />
            <button 
              onClick={generateCode}
              className="w-full bg-blue-500 text-white py-3 rounded"
            >
              Generate from Input
            </button>
          </div>

          {/* Global Commands */}
          <div className="mb-4 bg-white p-4 rounded shadow">
            <h2 className="text-lg font-semibold mb-2">Global Commands</h2>
            <select
              value={globalCommand}
              onChange={(e) => setGlobalCommand(e.target.value)}
              className="border p-3 w-full mb-2 text-base rounded"
            >
              <option value="">Select Command</option>
              <option value="Start All">Start All</option>
              <option value="Stop All">Stop All</option>
              <option value="Restart All">Restart All</option>
            </select>
            <button
              onClick={sendGlobalCommand}
              className="w-full bg-blue-500 text-white py-3 rounded"
            >
              Execute Global Command
            </button>
          </div>

          {/* Bot Overseer */}
          <div className="mb-4 bg-white p-4 rounded shadow">
            <h2 className="text-lg font-semibold mb-2">Bots</h2>
            <div className="overflow-x-auto">
              <table className="w-full border-collapse text-base">
                <thead>
                  <tr className="bg-gray-200">
                    <th className="border p-3">Name</th>
                    <th className="border p-3">Status</th>
                    <th className="border p-3">Perf</th>
                    <th className="border p-3">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {bots.map(bot => (
                    <tr key={bot.id}>
                      <td className="border p-3">{bot.name}</td>
                      <td className="border p-3">{bot.status}</td>
                      <td className="border p-3">{bot.performance}%</td>
                      <td className="border p-3">
                        <div className="flex flex-col space-y-2">
                          <select
                            onChange={(e) => sendCommand(bot.id, e.target.value)}
                            className="border p-2 text-base rounded"
                          >
                            <option value="">Command</option>
                            <option value="Start">Start</option>
                            <option value="Stop">Stop</option>
                            <option value="Restart">Restart</option>
                          </select>
                          <button 
                            onClick={() => startEditing(bot)} 
                            className="bg-yellow-500 text-white px-3 py-2 rounded text-base"
                          >
                            Edit
                          </button>
                          <button 
                            onClick={() => debugBot(bot.id)} 
                            className="bg-purple-500 text-white px-3 py-2 rounded text-base"
                          >
                            Debug
                          </button>
                          <button 
                            onClick={() => deployBot(bot.id)} 
                            className="bg-green-500 text-white px-3 py-2 rounded text-base"
                          >
                            Deploy
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* Code and Analysis */}
          {code && (
            <div className="mb-4 bg-white p-4 rounded shadow">
              <h2 className="text-lg font-semibold mb-2">Generated Bot</h2>
              {codeAnalysis && (
                <div className="text-base mb-2">
                  <p><strong>Name:</strong> {codeAnalysis.name}</p>
                  <p><strong>Description:</strong> {codeAnalysis.description}</p>
                  <p><strong>Functions:</strong> {codeAnalysis.functions.join(", ")}</p>
                  <p><strong>Value:</strong> {codeAnalysis.value}</p>
                  <p><strong>Risk:</strong> {codeAnalysis.risk}</p>
                </div>
              )}
              <pre className="border p-2 bg-gray-50 text-base">{code}</pre>
              <div className="mt-2 flex flex-wrap gap-2">
                <button 
                  onClick={suggestEdits}
                  className="flex-1 bg-yellow-500 text-white py-3 rounded text-base"
                >
                  Suggest Edits
                </button>
                <div className="flex-1">
                  <select
                    value={addFunctionOption}
                    onChange={(e) => setAddFunctionOption(e.target.value)}
                    className="border p-3 w-full mb-2 text-base rounded"
                  >
                    <option value="">Add Function</option>
                    <option value="Logging">Logging</option>
                    <option value="Email">Email Notification</option>
                  </select>
                  <button 
                    onClick={addFunction}
                    className="w-full bg-blue-500 text-white py-3 rounded text-base"
                  >
                    Add Selected
                  </button>
                </div>
                <div className="flex-1">
                  <select
                    onChange={(e) => removeFunction(e.target.value)}
                    className="border p-3 w-full mb-2 text-base rounded"
                  >
                    <option value="">Remove Function</option>
                    {codeAnalysis?.functions.map(func => (
                      <option key={func} value={func}>{func}</option>
                    ))}
                  </select>
                </div>
                <button 
                  onClick={refineDetails}
                  className="flex-1 bg-purple-500 text-white py-3 rounded text-base"
                >
                  Refine Details
                </button>
                <button 
                  onClick={copyCode}
                  className="flex-1 bg-gray-500 text-white py-3 rounded text-base"
                >
                  Copy Code
                </button>
                <button 
                  onClick={createBot}
                  className="flex-1 bg-green-500 text-white py-3 rounded text-base"
                  >
                    Create Bot
                  </button>
                </div>
              </div>
            )}

            {/* Edit Code */}
            {editingBot && (
              <div className="mb-4 bg-white p-4 rounded shadow">
                <h2 className="text-lg font-semibold mb-2">Edit: {editingBot.name}</h2>
                <textarea
                  value={code}
                  onChange={(e) => setCode(e.target.value)}
                  className="w-full h-48 border p-2 font-mono text-base rounded"
                  placeholder="Edit code"
                />
                <div className="mt-2 flex gap-2">
                  <button 
                    onClick={saveCode}
                    className="flex-1 bg-green-500 text-white py-3 rounded text-base"
                  >
                    Save
                  </button>
                  <button 
                    onClick={() => setEditingBot(null)}
                    className="flex-1 bg-red-500 text-white py-3 rounded text-base"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            )}

            {/* Suggested Bots */}
            <div className="mb-4 bg-white p-4 rounded shadow">
              <h2 className="text-lg font-semibold mb-2">Suggested Bots</h2>
              {suggestions.map((suggestion, index) => (
                <div key={index} className="flex justify-between items-center mb-2">
                  <span className="text-base">{suggestion}</span>
                  <button 
                    onClick={() => createSuggestedBot(suggestion)}
                    className="bg-blue-500 text-white px-3 py-2 rounded text-base"
                  >
                    Create
                  </button>
                </div>
              ))}
            </div>

            {/* Logs */}
            <div className="mb-4 bg-white p-4 rounded shadow">
              <h2 className="text-lg font-semibold mb-2">Logs</h2>
              <div className="h-48 overflow-y-auto border p-2 text-base">
                {logs.map((log, index) => (
                  <p key={index}>{log}</p>
                ))}
              </div>
              <button 
                onClick={clearLogs}
                className="w-full bg-red-500 text-white py-3 rounded mt-2"
              >
                Clear Logs
              </button>
            </div>

            {/* Bottom Nav */}
            <div className="fixed bottom-0 left-0 right-0 bg-white p-3 flex justify-around shadow">
              <button 
                onClick={() => window.scrollTo(0, 0)}
                className="text-blue-800 font-semibold text-base"
              >
                AI
              </button>
              <button 
                onClick={() => document.querySelector('table').scrollIntoView()}
                className="text-blue-800 font-semibold text-base"
              >
                Bots
              </button>
              <button 
                onClick={() => document.querySelector('.h-48').scrollIntoView()}
                className="text-blue-800 font-semibold text-base"
              >
                Logs
              </button>
            </div>
          </div>
        );
      };
      ReactDOM.render(<BotHub />, document.getElementById('root'));
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker registration failed:', err));
        });
      }
    </script>
  </body>
</html>