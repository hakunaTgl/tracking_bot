<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6200ea">
    <title>Smart Bot Hub</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        #chatArea { max-height: 300px; overflow-y: auto; }
        .log-entry { border-bottom: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md mt-4">
        <div id="login" class="space-y-4">
            <h2 class="text-2xl font-bold text-center">Smart Bot Hub Login</h2>
            <input type="email" id="email" placeholder="Email" class="border rounded p-2 w-full">
            <input type="password" id="password" placeholder="Password" class="border rounded p-2 w-full">
            <button onclick="signIn()" class="bg-purple-600 text-white p-2 rounded w-full hover:bg-purple-700">Login</button>
            <button onclick="signUp()" class="bg-gray-600 text-white p-2 rounded w-full hover:bg-gray-700">Sign Up</button>
            <p class="text-red-500 text-center" id="error"></p>
        </div>
        <div id="hub" class="space-y-4 hidden">
            <h2 class="text-2xl font-bold text-center">Smart Bot Hub</h2>
            <p>Welcome, <span id="userEmail" class="font-semibold"></span>! <button onclick="signOut()" class="text-purple-600 underline">Logout</button></p>
            <div class="space-y-2">
                <input type="text" id="userInput" placeholder="Ask the AI..." class="border rounded p-2 w-full">
                <button onclick="sendMessage()" class="bg-purple-600 text-white p-2 rounded w-full hover:bg-purple-700">Send</button>
            </div>
            <div id="chatArea" class="p-4 bg-gray-50 rounded"></div>
            <div class="space-y-2">
                <h3 class="text-xl font-semibold">Your Logs</h3>
                <input type="text" id="logSearch" placeholder="Search logs..." class="border rounded p-2 w-full" oninput="searchLogs()">
                <div id="logs" class="space-y-2"></div>
            </div>
            <div id="bossArea" class="space-y-2 hidden">
                <h3 class="text-xl font-semibold">Boss View: All Logs</h3>
                <div id="allLogs" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBONwaRl23VeTJISmiQ3X-t3y6FGK7Ngjc",
            authDomain: "tglsmarthub.firebaseapp.com",
            projectId: "tglsmarthub",
            storageBucket: "tglsmarthub.firebasestorage.app",
            messagingSenderId: "361291241205",
            appId: "1:361291241205:web:854f79a0238e6e4795d7bc",
            measurementId: "G-LQ4BP8GG37"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Check user state
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login').classList.add('hidden');
                document.getElementById('hub').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                loadLogs(user.uid);
                checkBossAccess(user.email);
            } else {
                document.getElementById('login').classList.remove('hidden');
                document.getElementById('hub').classList.add('hidden');
            }
        });

        // Validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Sign Up
        function signUp() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            if (!email || !password) {
                showMessage('Please enter both email and password.');
                return;
            }
            if (!isValidEmail(email)) {
                showMessage('Invalid email format. Use something like user@example.com.');
                return;
            }
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters.');
                return;
            }
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => showMessage('Signed up! Logging you in...'))
                .catch(error => showMessage(error.message));
        }

        // Sign In
        function signIn() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            if (!email || !password) {
                showMessage('Please enter both email and password.');
                return;
            }
            if (!isValidEmail(email)) {
                showMessage('Invalid email format. Use something like user@example.com.');
                return;
            }
            auth.signInWithEmailAndPassword(email, password)
                .then(() => showMessage('Logged in!'))
                .catch(error => showMessage(error.message));
        }

        // Sign Out
        function signOut() {
            auth.signOut().then(() => showMessage('Logged out!'));
        }

        // Check if user is "boss"
        function checkBossAccess(email) {
            const bossEmails = ['boss@example.com']; // Update with real boss emails
            if (bossEmails.includes(email)) {
                document.getElementById('bossArea').classList.remove('hidden');
                loadAllLogs();
            } else {
                document.getElementById('bossArea').classList.add('hidden');
            }
        }

        // Simulated AI with context awareness
        let conversationHistory = [];
        async function getAIResponse(input) {
            if (conversationHistory.includes(input)) {
                return `Yo, you asked "${input}" again? Here's a fresh spin: ${simulateAIResponse(input, true)}`;
            }
            conversationHistory.push(input);
            return simulateAIResponse(input, false);
        }

        // Simulate AI response (Grok-like personality)
        function simulateAIResponse(input, isFollowUp) {
            const responses = [
                `Alright, "${input}"? That’s a vibe! Imagine it’s like ${input} cranked to 11 with extra sauce.`,
                `Whoa, "${input}" hits hard! It’s like solving a puzzle in a sci-fi flick—here’s my take.`,
                `Yo, "${input}"? Picture it as a cosmic taco stuffed with ideas. Let’s unpack it!`
            ];
            const followUps = [
                `Back for more on "${input}"? It’s like diving into a sequel with extra plot twists!`,
                `Round two for "${input}"? Let’s remix it with some next-level chaos!`
            ];
            return isFollowUp ? followUps[Math.floor(Math.random() * followUps.length)] : responses[Math.floor(Math.random() * responses.length)];
        }

        // Send message to AI
        async function sendMessage() {
            const input = document.getElementById('userInput').value.trim();
            if (!input) {
                showMessage('Type something to chat with the AI!');
                return;
            }
            const user = auth.currentUser;
            if (!user) {
                showMessage('Please log in to chat.');
                return;
            }

            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML += `<p class="text-gray-800"><b>You:</b> ${input}</p>`;
            const response = await getAIResponse(input);
            chatArea.innerHTML += `<p class="text-purple-600"><b>AI:</b> ${response}</p>`;
            chatArea.scrollTop = chatArea.scrollHeight;

            await db.collection('logs').add({
                userId: user.uid,
                email: user.email,
                input: input,
                response: response,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            loadLogs(user.uid);
            document.getElementById('userInput').value = '';
        }

        // Load user logs
        let allUserLogs = [];
        async function loadLogs(userId) {
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = '';
            allUserLogs = [];
            const querySnapshot = await db.collection('logs')
                .where('userId', '==', userId)
                .orderBy('timestamp', 'desc')
                .get();
            querySnapshot.forEach(doc => {
                const log = doc.data();
                allUserLogs.push(log);
                logsDiv.innerHTML += `<div class="log-entry p-2">
                    <p class="text-sm text-gray-500"><b>${log.email}</b> (${new Date(log.timestamp?.toDate()).toLocaleString()}):</p>
                    <p><b>You:</b> ${log.input}</p>
                    <p><b>AI:</b> ${log.response}</p>
                </div>`;
            });
        }

        // Search logs
        function searchLogs() {
            const searchTerm = document.getElementById('logSearch').value.toLowerCase();
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = '';
            allUserLogs
                .filter(log => log.input.toLowerCase().includes(searchTerm) || log.response.toLowerCase().includes(searchTerm))
                .forEach(log => {
                    logsDiv.innerHTML += `<div class="log-entry p-2">
                        <p class="text-sm text-gray-500"><b>${log.email}</b> (${new Date(log.timestamp?.toDate()).toLocaleString()}):</p>
                        <p><b>You:</b> ${log.input}</p>
                        <p><b>AI:</b> ${log.response}</p>
                    </div>`;
                });
        }

        // Load all logs (boss view)
        async function loadAllLogs() {
            const allLogsDiv = document.getElementById('allLogs');
            allLogsDiv.innerHTML = '';
            const querySnapshot = await db.collection('logs')
                .orderBy('timestamp', 'desc')
                .get();
            querySnapshot.forEach(doc => {
                const log = doc.data();
                allLogsDiv.innerHTML += `<div class="log-entry p-2">
                    <p class="text-sm text-gray-500"><b>${log.email}</b> (${new Date(log.timestamp?.toDate()).toLocaleString()}):</p>
                    <p><b>User:</b> ${log.input}</p>
                    <p><b>AI:</b> ${log.response}</p>
                </div>`;
            });
        }

        // Show temporary message
        function showMessage(msg) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = msg;
            setTimeout(() => errorDiv.textContent = '', 3000);
        }

        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('Service Worker Registered:', registration.scope))
                    .catch(err => console.error('Service Worker Registration Failed:', err));
            });
        }
    </script>
</body>
</html>
